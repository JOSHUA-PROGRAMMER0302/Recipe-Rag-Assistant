<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Recipe Rag Assistant</title>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
  </head>
  <body class="bg-gray-50 min-h-screen">
    <header class="bg-white shadow">
      <div class="max-w-4xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between">
          <h1 class="text-2xl font-bold text-gray-900">Recipe Rag Assistant</h1>
          <nav class="space-x-3 text-sm">
            <a href="/frontend/index.html" class="text-blue-600">Search</a>
            <a href="/frontend/planner.html" class="text-blue-600">Planner</a>
            <a href="/frontend/dashboard.html" class="text-blue-600">Dashboard</a>
          </nav>
        </div>
        <div id="compressSummary" class="mt-3 text-sm text-gray-600">Loading compression statusâ€¦</div>
      </div>
    </header>

    <main class="max-w-4xl mx-auto p-4">
      <section class="my-6">
        <div class="flex gap-2">
          <input id="q" class="flex-1 px-4 py-2 border rounded" placeholder="Search recipes..." />
          <button id="searchBtn" class="px-4 py-2 bg-blue-600 text-white rounded">Search</button>
        </div>
        <div id="results" class="mt-4 space-y-3"></div>
      </section>
    </main>

    <script>
      const API_BASE = window.API_BASE || 'http://localhost:8000'
      const qInput = document.getElementById('q')
      const searchBtn = document.getElementById('searchBtn')
      const results = document.getElementById('results')
      const compressSummary = document.getElementById('compressSummary')

      let compressedSet = new Set()
      let compMap = {} // id -> entry

      async function loadCompressStatus(){
        try{
          const res = await fetch(`${API_BASE}/compress-status`)
          if(!res.ok) throw new Error('status '+res.status)
          const data = await res.json()
          const count = data.count || 0
          const bytes = data.bytes_saved || 0
          compressSummary.innerText = `Compressed recipes: ${count} Â· Bytes saved: ${bytes}`
          (data.entries || []).forEach(e=>{ if(e && e.id){ compressedSet.add(String(e.id)); compMap[String(e.id)] = e } })
        }catch(err){
          compressSummary.innerText = 'Compression status unavailable'
        }
      }

      async function doSearch(){
        const q = qInput.value.trim()
        results.innerHTML = '<div class="text-gray-500">Searchingâ€¦</div>'
        try{
          const res = await fetch(`${API_BASE}/search?q=${encodeURIComponent(q)}`)
          if(!res.ok) throw new Error(`Search failed: ${res.status}`)
          const data = await res.json()
          const list = Array.isArray(data) ? data : (data.recipes || [])
          if(!list || list.length === 0){ results.innerHTML = '<div class="p-4 bg-white rounded shadow text-gray-500">No results</div>'; return }
          results.innerHTML = ''
          for(const r of list){
            const card = document.createElement('a')
            card.href = `/frontend/recipe.html?id=${encodeURIComponent(r.id)}`
            card.className = 'block bg-white p-4 rounded-lg shadow hover:shadow-md transition flex gap-4 items-start'
            const left = document.createElement('div')
            left.className = 'w-14 h-14 bg-gray-100 rounded flex items-center justify-center text-gray-400'
            left.innerText = 'ðŸ½ï¸'
            const body = document.createElement('div')
            body.className = 'flex-1'
            const title = document.createElement('div')
            title.className = 'font-semibold text-lg text-gray-900'
            title.innerText = r.title || 'Untitled'
            const ingPreview = (r.ingredients || []).slice(0,3).map(i => (typeof i === 'string') ? i : (i.name || i.raw)).join(', ')
            const sub = document.createElement('div')
            sub.className = 'text-sm text-gray-600 mt-1'
            sub.innerText = ingPreview
            const right = document.createElement('div')
            right.className = 'text-sm text-right'
            if(compressedSet.has(String(r.id))){
              const b = document.createElement('div')
              b.className = 'text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full inline-block'
              const e = compMap[String(r.id)]
              const saved = (e && e.orig_len && e.compressed_len) ? ((e.orig_len - e.compressed_len) + ' bytes') : 'Compressed'
              b.innerText = saved
              right.appendChild(b)
            }
            body.appendChild(title)
            body.appendChild(sub)
            card.appendChild(left)
            card.appendChild(body)
            card.appendChild(right)
            results.appendChild(card)
          }
        }catch(err){
          results.innerHTML = `<div class="text-red-600">Error: ${err.message}</div>`
        }
      }

      // init
      loadCompressStatus()
      searchBtn.addEventListener('click', doSearch)
      qInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') doSearch() })
    </script>
  </body>
</html>
